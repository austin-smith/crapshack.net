---
import Layout from '../layouts/Layout.astro';
import Dialog from '../components/ui/Dialog.astro';
import ToggleGroup from '../components/ui/ToggleGroup.astro';
import Tooltip from '../components/ui/Tooltip.astro';
import { Package } from '@lucide/astro';

const repoUrl = 'https://github.com/austin-smith/ComputerSolitaire';
const releasesUrl = 'https://github.com/austin-smith/ComputerSolitaire/releases';
const klondikeUrl = 'https://en.wikipedia.org/wiki/Klondike_(solitaire)';
const iconUrl = '/images/computer-solitaire/computer-solitaire-icon.png';
const screenshotIos = '/images/computer-solitaire/screen-grabs/screen-grab-ios.png';
---

<Layout
	title="crapshack (computer solitaire)"
	ogImage="/open-graph/computer-solitaire.png"
	noIndex={true}
>
	<section class="mx-auto max-w-3xl space-y-8 mt-10">
		<header class="flex items-center gap-4">
			<img src={iconUrl} alt="Computer Solitaire icon" width="96" height="96" class="rounded-2xl drop-shadow-md" loading="lazy" />
			<div>
				<h1 class="text-3xl font-mono font-semibold bg-gradient-to-r from-[var(--color-brand)] to-white bg-clip-text text-transparent">Computer Solitaire</h1>
				<p class="text-white/90">A fully native Solitaire app for iOS, iPadOS, and macOS.</p>
			</div>
		</header>

		<div class="flex flex-wrap gap-3">
			<a
				href={repoUrl}
				target="_blank"
				rel="noopener noreferrer"
				class="inline-flex items-center rounded-md bg-[var(--color-brand)] px-4 py-2 font-medium hover:opacity-90 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[var(--color-brand)]/70"
			>
				<img src="/images/brands/github-black.svg" alt="" aria-hidden="true" class="mr-2 h-4 w-4" />
				<span>github</span>
			</a>
			<a
				href={releasesUrl}
				target="_blank"
				rel="noopener noreferrer"
				class="inline-flex items-center rounded-md border border-white/20 px-4 py-2 font-medium text-[var(--color-text)] hover:text-[var(--color-brand)] focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[var(--color-brand)]/70"
			>
				<Package width={16} height={16} stroke-width={2} class="mr-2" />
				<span>releases</span>
			</a>
		</div>

		<div class="screenshots flex flex-wrap items-start gap-4">
			<button
				type="button"
				class="screenshot-trigger group relative rounded-xl overflow-hidden border border-white/10 shadow-lg h-[13rem] sm:h-[18rem] focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[var(--color-brand)]"
				data-screenshot-trigger
				data-id="ios"
			>
				<img src={screenshotIos} alt="Computer Solitaire on iOS" class="h-full w-auto opacity-0 transition-all duration-300 group-hover:scale-[1.02]" data-screenshot loading="lazy" />
			</button>
			<button
				type="button"
				class="screenshot-trigger group relative rounded-xl overflow-hidden border border-white/10 shadow-lg h-[13rem] sm:h-[18rem] focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[var(--color-brand)]"
				data-screenshot-trigger
				data-id="macos"
			>
				<img src="/images/computer-solitaire/screen-grabs/screen-grab-macos.png" alt="Computer Solitaire on macOS" class="h-full w-auto opacity-0 transition-all duration-300 group-hover:scale-[1.02]" data-screenshot loading="lazy" />
			</button>
		</div>

		<Dialog id="screenshot-dialog" maxWidth="max-w-4xl" ariaLabel="Computer Solitaire screenshot dialog">
			<img id="screenshot-dialog-img" src="" alt="" class="w-full max-h-[75vh] object-contain rounded-lg" />
			<div class="flex justify-center">
				<ToggleGroup
					name="screenshot-platform"
					options={[
						{ value: 'ios', label: 'ios' },
						{ value: 'macos', label: 'macos' },
					]}
					defaultValue="ios"
					ariaLabel="Screenshot platform"
				/>
			</div>
		</Dialog>

		<section class="space-y-3">
			<h2 class="text-2xl font-mono font-semibold text-[var(--color-text)]"># Features</h2>
			<ul class="list-disc pl-6 space-y-1 text-white/95">
				<li>Fully native apps for iOS, iPadOS, and macOS</li>
				<li>Automatic game persistence and resume</li>
				<li>Support for 1-card and 3-card Klondike variants</li>
				<li>Customizable table appearance</li>
				<li>Other things you enjoy</li>
			</ul>
		</section>

		<section class="space-y-3">
			<h2 class="text-2xl font-mono font-semibold text-[var(--color-text)]"># About Klondike</h2>
			<p class="text-white/95">
				<a class="underline decoration-[var(--color-brand)] underline-offset-4 hover:text-[var(--color-brand)]" href={klondikeUrl} target="_blank" rel="noopener noreferrer">Klondike</a>
				is the most popular variant of solitaire, played with a standard 52-card deck and the goal of building all four suits in order from Ace through King.
			</p>
			<p class="text-white/95">
				Computer Solitaire follows classic Klondike rules and supports both
				<Tooltip id="draw-one-tooltip" trigger="draw-one">
					<span class="font-semibold text-white">Draw-one:</span>
					deal one card from the stock to the waste at a time.
				</Tooltip>
				and
				<Tooltip id="draw-three-tooltip" trigger="draw-three">
					<span class="font-semibold text-white">Draw-three:</span>
					deal three cards at a time, with only the top card immediately available to play.
				</Tooltip>
				play.
			</p>
			<div>
				<button
					id="computer-solitaire-guide-trigger"
					type="button"
					class="inline-flex items-center rounded-md border border-white/20 px-3 py-1.5 text-sm font-medium text-[var(--color-text)] hover:text-[var(--color-brand)] focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-[var(--color-brand)]/70"
				>
					computer solitaire guide
				</button>
			</div>
		</section>

		<Dialog id="computer-solitaire-guide-dialog" maxWidth="max-w-3xl" ariaLabel="Computer Solitaire guide dialog">
			<div class="space-y-5 text-white/95">
				<div class="space-y-2">
					<h2 class="text-2xl font-mono font-semibold text-[var(--color-text)]"># Computer Solitaire Guide</h2>
				</div>

				<div class="flex justify-center sm:justify-start">
					<ToggleGroup
						name="computer-solitaire-guide-section"
						options={[
							{ value: 'rules', label: 'rules' },
							{ value: 'scoring', label: 'scoring' },
							{ value: 'terms', label: 'terms' },
						]}
						defaultValue="rules"
						ariaLabel="Computer Solitaire guide section"
					/>
				</div>

				<section class="space-y-4" data-computer-solitaire-guide-panel="rules">
					<div class="space-y-2">
						<h3 class="text-lg font-semibold text-[var(--color-text)]">Objective</h3>
						<p>Move all 52 cards to the four foundations, building each suit from Ace to King.</p>
					</div>

					<div class="space-y-2">
						<h3 class="text-lg font-semibold text-[var(--color-text)]">Core Rules</h3>
						<ul class="list-disc pl-6 space-y-1">
							<li>Use a standard 52-card deck and deal seven tableau piles, with only the top card face up in each pile.</li>
							<li>Build tableau piles down in rank while alternating colors.</li>
							<li>You may move a face-up card or a properly ordered sequence as a unit.</li>
							<li>Empty tableau spaces may be filled only by a King (or a sequence starting with a King).</li>
							<li>Build foundations by suit from Ace to King.</li>
							<li>When the stock is empty, recycle waste to stock and continue (unlimited passes).</li>
						</ul>
					</div>

					<div class="space-y-2">
						<h3 class="text-lg font-semibold text-[var(--color-text)]">Draw Modes</h3>
						<ul class="list-disc pl-6 space-y-1">
							<li><span class="font-semibold text-white">1-card draw:</span> turn one card at a time from stock to waste; only the top waste card is playable.</li>
							<li><span class="font-semibold text-white">3-card draw:</span> turn three cards at a time; only the top waste card is playable.</li>
						</ul>
					</div>
				</section>

				<section class="space-y-3" data-computer-solitaire-guide-panel="scoring" hidden>
					<div class="space-y-2">
						<h3 class="text-lg font-semibold text-[var(--color-text)]">Move Points</h3>
						<ul class="list-disc pl-6 space-y-1">
							<li><span class="font-semibold text-white">Waste to Tableau:</span> +5</li>
							<li><span class="font-semibold text-white">Waste to Foundation:</span> +10</li>
							<li><span class="font-semibold text-white">Tableau to Foundation:</span> +10</li>
							<li><span class="font-semibold text-white">Turn over Tableau card:</span> +5</li>
							<li><span class="font-semibold text-white">Foundation to Tableau:</span> -15</li>
							<li><span class="font-semibold text-white">Recycle waste in 1-card draw:</span> -100</li>
						</ul>
					</div>
					<div class="space-y-2">
						<h3 class="text-lg font-semibold text-[var(--color-text)]">Timed Bonus</h3>
						<ul class="list-disc pl-6 space-y-1">
							<li>On win, a time bonus is added.</li>
							<li>Time bonus starts at 600 in 1-card draw and 900 in 3-card draw.</li>
							<li>The bonus drops by 1 point per second.</li>
							<li>Score cannot go below 0.</li>
						</ul>
					</div>
				</section>

				<section class="space-y-2" data-computer-solitaire-guide-panel="terms" hidden>
					<ul class="list-disc pl-6 space-y-1">
						<li><span class="font-semibold text-white">Tableau:</span> the seven play piles where you build down in alternating colors.</li>
						<li><span class="font-semibold text-white">Foundations:</span> four suit piles built up from Ace to King.</li>
						<li><span class="font-semibold text-white">Stock:</span> the face-down draw pile.</li>
						<li><span class="font-semibold text-white">Waste:</span> face-up cards drawn from stock; only the top card is playable.</li>
						<li><span class="font-semibold text-white">Draw mode:</span> how many cards are drawn from stock each time (1-card or 3-card).</li>
					</ul>
				</section>
			</div>
		</Dialog>
	</section>
</Layout>

<script>
	import { openDialog } from '../lib/ui/dialog';

	const screenshots = document.querySelectorAll<HTMLImageElement>('[data-screenshot]');
	screenshots.forEach((img, i) => {
		const fadeIn = () => {
			setTimeout(() => {
				img.classList.remove('opacity-0');
				img.classList.add('opacity-100');
			}, i * 100);
		};
		if (img.complete) {
			fadeIn();
		} else {
			img.addEventListener('load', fadeIn, { once: true });
		}
	});

	const screenshotTriggers = document.querySelectorAll<HTMLButtonElement>('[data-screenshot-trigger]');
	const dialogImg = document.getElementById('screenshot-dialog-img') as HTMLImageElement | null;
	const toggleGroup = document.querySelector<HTMLElement>('[data-toggle-group="screenshot-platform"]');
	const computerSolitaireGuideTrigger = document.getElementById('computer-solitaire-guide-trigger') as HTMLButtonElement | null;
	const computerSolitaireGuideDialog = document.getElementById('computer-solitaire-guide-dialog') as HTMLElement | null;
	const computerSolitaireGuideToggle = document.querySelector<HTMLElement>('[data-toggle-group="computer-solitaire-guide-section"]');
	const computerSolitaireGuidePanels = document.querySelectorAll<HTMLElement>('[data-computer-solitaire-guide-panel]');

	const screenshotSources: Record<string, { src: string; alt: string }> = {
		ios: { src: '/images/computer-solitaire/screen-grabs/screen-grab-ios.png', alt: 'Computer Solitaire on iOS' },
		macos: { src: '/images/computer-solitaire/screen-grabs/screen-grab-macos.png', alt: 'Computer Solitaire on macOS' },
	};

	function setScreenshot(platform: string) {
		const source = screenshotSources[platform];
		if (source && dialogImg) {
			dialogImg.src = source.src;
			dialogImg.alt = source.alt;
		}
	}

	screenshotTriggers.forEach((trigger) => {
		trigger.addEventListener('click', () => {
			const id = trigger.dataset.id;
			if (dialogImg && id) {
				setScreenshot(id);
				document.dispatchEvent(new CustomEvent('toggle-set-value', {
					detail: { name: 'screenshot-platform', value: id }
				}));
				openDialog('screenshot-dialog');
			}
		});
	});

	toggleGroup?.addEventListener('toggle-change', ((e: CustomEvent<{ value: string }>) => {
		setScreenshot(e.detail.value);
	}) as EventListener);

	function syncComputerSolitaireGuideToggle() {
		const checkedGuideInput = document.querySelector<HTMLInputElement>(
			'[data-toggle-group="computer-solitaire-guide-section"] input[type="radio"]:checked'
		);
		if (!checkedGuideInput) return;
		document.dispatchEvent(new CustomEvent('toggle-set-value', {
			detail: { name: 'computer-solitaire-guide-section', value: checkedGuideInput.value }
		}));
	}

	computerSolitaireGuideTrigger?.addEventListener('click', () => {
		openDialog('computer-solitaire-guide-dialog');
		requestAnimationFrame(() => {
			syncComputerSolitaireGuideToggle();
		});
		computerSolitaireGuideDialog?.querySelector<HTMLElement>('[data-dialog-container]')?.addEventListener('transitionend', () => {
			syncComputerSolitaireGuideToggle();
		}, { once: true });
	});

	function setComputerSolitaireGuideSection(value: string) {
		computerSolitaireGuidePanels.forEach((panel) => {
			panel.hidden = panel.dataset.computerSolitaireGuidePanel !== value;
		});
	}

	setComputerSolitaireGuideSection('rules');

	computerSolitaireGuideToggle?.addEventListener('toggle-change', ((e: CustomEvent<{ value: string }>) => {
		setComputerSolitaireGuideSection(e.detail.value);
	}) as EventListener);
</script>
